angular.module("app",[]).factory("Weather",["$q","$http",function(e,t){return this.api="http://api.openweathermap.org/data/2.5/weather?",this.units="&units=metric",this.appKey="&appid=5ea3bc93110c2c2d7596cb94cd4316f9",this.cb="&callback=JSON_CALLBACK",this.byCityName=function(a){var n=e.defer();return a&&t.jsonp(this.api+this.units+this.appKey+this.cb+"&q="+encodeURI(a)).then(function(e){var t=parseInt(e.data.cod);200===t?n.resolve(e.data):n.reject(e.data.message)},function(e){n.reject(e)}),n.promise},this.byCityId=function(a){var n=e.defer();return t.jsonp(this.api+this.units+this.appKey+this.cb+"&id="+a).then(function(e){var t=parseInt(e.data.cod);200===t?n.resolve(e.data):n.reject(e.data.message)},function(e){n.reject(e)}),n.promise},this}]).factory("LocalWeather",["$http","Weather",function(e,t){var a={};return a.getLocation=function(){return e.jsonp("http://ipinfo.io/json?callback=JSON_CALLBACK")},a.getWeather=function(a,n){return e.jsonp(t.api+a+n+t.units+t.appKey+t.cb)},a}]).controller("WeatherCTRL",["$scope","$window","$interval","LocalWeather","Weather",function(e,t,a,n,r){function i(t){e.temp=t.main.temp||0,e.city=t.name||"We're sorry",e.country=t.sys.country||"We're sorry",e.humidity=t.main.humidity||0,e.wind=t.wind.speed||0,e.iconKey=t.weather[0].main||0,e.icon=o(e.iconKey,t.dt)||o("Error")}function o(t,a){var n=angular.element(document.querySelector("#customPanelHeading"));if("Clear"==t||"Haze"==t?n.hasClass("covered")?n.removeClass("covered").addClass("clear"):n.addClass("clear"):n.hasClass("clear")?n.removeClass("clear").addClass("covered"):n.addClass("covered"),s[e.iconKey])return"Clear"===t?s[t][c(a)]:s[t]}function c(e){var t=new Date(1e3*e).getHours();return t>6&&t<20?"day":"night"}e.places=angular.fromJson(t.localStorage.getItem("places")||"[]");var s={Clear:{day:"wi wi-day-sunny",night:"wi wi-night-clear"},Clouds:"wi wi-cloudy",Snow:"wi wi-snow",Rain:"wi wi-rain",Drizzle:"wi wi-sprinkle",Thunderstorm:"wi wi-thunderstorm",Haze:"wi wi-day-haze",Mist:"wi wi-fog",Error:"glyphicon glyphicon-remove-sign"};e.unit="C",n.getLocation().success(function(e){var t="lat="+e.loc.split(",")[0],a="&lon="+e.loc.split(",")[1];n.getWeather(t,a).success(function(e){i(e)}).error(function(e){alert("Sorry, we can't show you weather right now, please try again later")})}).error(function(e){alert("Sorry, we can't get your location right now, please try again later")}),e.watchCity=function(e){var t=localStorage.getItem("places",e);t=JSON.parse(t),i(t[e])},e.addPlace=function(a){e.places.push(a),t.localStorage.setItem("places",angular.toJson(e.places)),angular.element(document.querySelector("#cityAdd")).val("")},e.removePlace=function(a){e.places.splice(a,1),t.localStorage.setItem("places",angular.toJson(e.places))},e.updateWeather=function(){for(var t=function(t,a){r.byCityId(t.id).then(function(t){e.places[a]=t})},a=0,n=e.places.length;a<n;a++)t(e.places[a],a)},a(e.updateWeather,6e4),e.search=function(){r.byCityName(e.query).then(function(e){i(e)},function(){t.alert("Unable to find city")})},e.addCity=function(){r.byCityName(e.query).then(function(a){for(var n=0,r=e.places.length;n<r;n++){var o=e.places[n];if(o.id===a.id)return void t.alert("This city is already added")}e.addPlace(a),i(a)},function(){t.alert("Unable to find city")})}}]).filter("round",function(){return function(e){return Math.round(e)}}).filter("belowAbove",function(){return function(e){return e>0?"+"+e:"-"+e}});